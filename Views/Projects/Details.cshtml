@model ProjectManagementSystem.Models.ViewModels.ProjectDetailsVm

@{
    ViewData["Title"] = "Project Details";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
}

<style>
    [v-cloak] {
        display: none;
    }

    /* Modal 相關樣式 */
    .form-control:focus,
    .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .was-validated .form-control:invalid:focus,
    .was-validated .form-select:invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }

    .was-validated .form-control:valid:focus,
    .was-validated .form-select:valid:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
    }

    /* Modal 過渡動畫 */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
    }

    .modal.fade.show .modal-dialog {
        transform: none;
    }
</style>

<div class="container" id="app" v-cloak>
    <!-- 載入指示器 -->
    <div v-if="loading" class="text-center my-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 錯誤訊息 -->
    <div v-if="error" class="alert alert-danger" role="alert">
        {{ error }}
    </div>

    <!-- 專案詳情卡片 -->
    <div v-if="!loading && !error" class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0">{{project.name}}</h3>
            <div>
                <button type="button" class="btn btn-primary" id="editProjectBtn">
                    <i class="bi bi-pencil"></i> Edit Project
                </button>
                <a href="/Projects" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Description</dt>
                <dd class="col-sm-9">{{project.description || 'No description provided'}}</dd>

                <dt class="col-sm-3">Status</dt>
                <dd class="col-sm-9">
                    <span :class="'badge bg-' + getStatusColor(project.status)">
                        {{project.status}}
                    </span>
                </dd>

                <dt class="col-sm-3">Project Manager</dt>
                <dd class="col-sm-9">{{project.ownerName || 'Not assigned'}}</dd>

                <dt class="col-sm-3">Start Date</dt>
                <dd class="col-sm-9">{{formatDate(project.startDate)}}</dd>

                <dt class="col-sm-3">End Date</dt>
                <dd class="col-sm-9">{{ project.endDate ? formatDate(project.endDate) : 'Not Set' }}</dd>
            </dl>
        </div>
    </div>

    <!-- 任務列表卡片 -->
    <div v-if="!loading && !error" class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Tasks</h3>
                <button class="btn btn-success" id="addTaskBtn">
                    <i class="bi bi-plus"></i> Add Task
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-4">
                    <select class="form-select" v-model="filter.deadlineStatus">
                        <option value="all">所有任務</option>
                        <option value="upcoming">即將到期(3天內)</option>
                        <option value="overdue">已逾期</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" v-model="filter.sortBy">
                        <option value="dueDate">依到期日</option>
                        <option value="priority">依優先度</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body">
            <table class="table" v-if="filteredTasks.length">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Due Date</th>
                        <th>Priority</th>
                        <th>Assigned To</th>
                        <th>Remaining Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="task in filteredTasks"
                        :key="task.taskId"
                        :class="getTaskRowClass(task)">
                        <td>{{task.title}}</td>
                        <td>
                            <span :class="'badge bg-' + getStatusColor(task.status)">
                                {{task.status}}
                            </span>
                        </td>
                        <td>{{formatDate(task.dueDate)}}</td>
                        <td>
                            <span :class="'badge bg-' + getPriorityColor(task.priority)">
                                {{task.priority}}
                            </span>
                        </td>
                        <td>{{task.assignedToName || ''}}</td>
                        <td v-if="task.status !='已完成'">
                            <span :class="{'text-danger': calculateDaysUntilDue(task.dueDate) < 0}">
                                {{getDaysRemaining(task)}}
                            </span>
                        </td>
                        <td v-else>-</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-info edit-task-btn" 
                                        :data-task-id="task.taskId"
                                        :disabled="isSubmitting">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-task-btn" :data-task-id="task.taskId">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <a class="btn btn-sm btn-secondary" 
                                   :href="'/File/Index?taskId=' + task.taskId"
                                   title="檔案管理">
                                    <i class="bi bi-file-earmark-text"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p v-else class="text-center py-4">No tasks available for this project.</p>
        </div>
    </div>

    <!-- 引入編輯專案 Modal -->
    <partial name="_ProjectEditModal" model="Model" />

    <!-- 引入創建任務 Modal -->
    <partial name="_TaskCreateModal" model="Model" />

    <!-- 引入編輯任務 Modal -->
    <partial name="_TaskEditModal" model="Model" />
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                const today = new Date().toISOString().split('T')[0];
                return {
                    project: {
                        projectId: @Model.ProjectId,
                        name: @Html.Raw(Json.Serialize(Model.Name ?? "")),
                        description: @Html.Raw(Json.Serialize(Model.Description ?? "")),
                        status: @Html.Raw(Json.Serialize(Model.Status ?? "")),
                        ownerId: @Html.Raw(Json.Serialize(Model.OwnerId.ToString())),
                        ownerName: @Html.Raw(Json.Serialize(Model.OwnerName ?? "")),
                        startDate: @Html.Raw(Json.Serialize(Model.StartDate.ToString("yyyy-MM-dd"))),
                        endDate: @Html.Raw(Json.Serialize(Model.EndDate.HasValue ? Model.EndDate.Value.ToString("yyyy-MM-dd") : "")),
                        tasks: []
                    },
                    projectManagers: @Html.Raw(Json.Serialize(Model.ProjectManagers ?? new List<SelectListItem>())),
                    statusOptions: @Html.Raw(Json.Serialize(Model.StatusOptions ?? new List<SelectListItem>())),
                    taskForm: {
                        title: '',
                        description: '',
                        status: '未開始',
                        priority: '',
                        dueDate: today,
                        assignedToId: '',
                        projectId: @Model.ProjectId
                    },
                    editTaskForm: {
                        taskId: null,
                        title: '',
                        description: '',
                        status: '',
                        priority: '',
                        dueDate: '',
                        assignedToId: null
                    },
                    taskEditModal: null,
                    taskStatusOptions: @Html.Raw(Json.Serialize(Model.TaskCreateVm.Statuses ?? new List<SelectListItem>())),
                    taskPriorityOptions: @Html.Raw(Json.Serialize(Model.TaskCreateVm.Priorities ?? new List<SelectListItem>())),
                    teamMembers: @Html.Raw(Json.Serialize(Model.TaskCreateVm.TeamMembers ?? new List<SelectListItem>())),
                    loading: true,
                    error: null,
                    editModal: null,
                    taskCreateModal: null,
                    isSubmitting: false,
                    validationRules: {
                        statuses: ['未開始', '進行中', '已完成'],
                        priorities: ['高', '中', '低']
                    },
                    filter: {
                        deadlineStatus: 'all',
                        sortBy: 'dueDate'
                    }
                }
            },
            computed: {
                filteredTasks() {
                    if (!this.project.tasks) return [];

                    return this.project.tasks
                        .filter(task => {
                            const daysUntilDue = this.calculateDaysUntilDue(task.dueDate);
                            switch (this.filter.deadlineStatus) {
                                case 'upcoming':
                                    return daysUntilDue <= 3 && daysUntilDue >= 0 && task.status !== '已完成';
                                case 'overdue':
                                    return daysUntilDue < 0 && task.status !== '已完成';
                                default:
                                    return true;
                            }
                        })
                        .sort((a, b) => {
                            if (this.filter.sortBy === 'dueDate') {
                                return new Date(a.dueDate) - new Date(b.dueDate);
                            }
                            const priorityValues = { '高': 3, '中': 2, '低': 1 };
                            return priorityValues[b.priority] - priorityValues[a.priority];
                        });
                }
            },

            methods: {
                //公共工具methods
                formatDate(date) {
                    if (!date) return 'Not Set';

                    try {
                        if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                            return date;
                        }

                        const d = new Date(date);
                        if (isNaN(d.getTime())) return 'Not Set';

                        return d.toISOString().split('T')[0];
                    } catch {
                        return 'Not Set';
                    }
                },

                getStatusColor(status) {
                    const colors = {
                        '未開始': 'secondary',
                        '進行中': 'primary',
                        '已完成': 'success',
                        '已取消': 'danger'
                    };
                    return colors[status] || 'info';
                },

                getPriorityColor(priority) {
                    const colors = {
                        '高': 'danger',
                        '中': 'warning',
                        '低': 'info'
                    };
                    return colors[priority] || 'secondary';
                },

                //事件初始化
                initializeAllEventListeners() {
                    console.log('Initializing all event listeners');

                    // 初始化編輯專案相關事件
                    if (!this.editModal) {
                        this.editModal = new bootstrap.Modal(document.getElementById('projectEditModal'));
                    }

                    // 初始化任務 Modal
                    if (!this.taskCreateModal) {
                        this.taskCreateModal = new bootstrap.Modal(document.getElementById('taskCreateModal'));
                    }

                    // 綁定編輯專案按鈕
                    const editBtn = document.getElementById('editProjectBtn');
                    if (editBtn) {
                        editBtn.removeEventListener('click', this.showEditModal);
                        editBtn.addEventListener('click', () => this.showEditModal());
                    }

                    // 綁定儲存專案按鈕
                    const saveBtn = document.getElementById('saveProjectBtn');
                    if (saveBtn) {
                        saveBtn.removeEventListener('click', this.handleSave);
                        saveBtn.addEventListener('click', () => this.handleSave());
                    }

                    // 綁定專案 Modal 關閉事件
                    const projectModal = document.getElementById('projectEditModal');
                    if (projectModal) {
                        projectModal.removeEventListener('hidden.bs.modal', this.resetFormValidation);
                        projectModal.addEventListener('hidden.bs.modal', () => this.resetFormValidation());
                    }

                    // 綁定新增任務按鈕
                    const addTaskBtn = document.getElementById('addTaskBtn');
                    if (addTaskBtn) {
                        addTaskBtn.removeEventListener('click', this.showCreateTaskModal);
                        addTaskBtn.addEventListener('click', () => this.showCreateTaskModal());
                    }

                    // 綁定儲存任務按鈕
                    const saveTaskBtn = document.getElementById('saveTaskBtn');
                    if (saveTaskBtn) {
                        saveTaskBtn.removeEventListener('click', this.handleSaveTask);
                        saveTaskBtn.addEventListener('click', () => this.handleSaveTask());
                    }

                    // 綁定任務 Modal 關閉事件
                    const taskModal = document.getElementById('taskCreateModal');
                    if (taskModal) {
                        taskModal.removeEventListener('hidden.bs.modal', this.resetTaskForm);
                        taskModal.addEventListener('hidden.bs.modal', () => this.resetTaskForm());
                    }

                    // 綁定所有刪除按鈕
                    const deleteButtons = document.querySelectorAll('.delete-task-btn');
                    if (deleteButtons) {
                        deleteButtons.forEach(btn => {
                            btn.removeEventListener('click', this.handleDeleteClick);
                            btn.addEventListener('click', () => this.handleDeleteClick(btn));
                        });
                    }

                    // 初始化編輯任務 Modal
                    if (!this.taskEditModal) {
                        this.taskEditModal = new bootstrap.Modal(document.getElementById('taskEditModal'));
                    }

                    // 綁定所有編輯按鈕
                    const editButtons = document.querySelectorAll('.edit-task-btn');
                    if (editButtons) {
                        editButtons.forEach(btn => {
                            btn.removeEventListener('click', this.handleEditClick);
                            btn.addEventListener('click', () => {
                                const taskId = parseInt(btn.dataset.taskId);
                                this.handleEditClick(taskId);
                            });
                        });
                    }

                    // 綁定更新任務按鈕
                    const updateTaskBtn = document.getElementById('updateTaskBtn');
                    if (updateTaskBtn) {
                        updateTaskBtn.removeEventListener('click', this.updateTask);
                        updateTaskBtn.addEventListener('click', () => this.updateTask());
                    }

                    // 綁定編輯任務 Modal 關閉事件
                    const taskEditModal = document.getElementById('taskEditModal');
                    if (taskEditModal) {
                        taskEditModal.removeEventListener('hidden.bs.modal', this.resetEditTaskForm);
                        taskEditModal.addEventListener('hidden.bs.modal', () => this.resetEditTaskForm());
                    }
                },

                //專案相關methods
                async loadProject() {
                    try {
                        this.loading = true;
                        console.log('Loading project ID:', this.project.projectId);

                        const response = await axios.get(`/api/ProjectsApi/${this.project.projectId}`);
                        console.log('API Response:', response.data);

                        const updatedProject = response.data;

                        this.project = {
                            ...this.project,
                            ...updatedProject,
                            ownerId: updatedProject.ownerId.toString(),
                            startDate: this.formatDate(updatedProject.startDate),
                            endDate: updatedProject.endDate ? this.formatDate(updatedProject.endDate) : '',
                            tasks: updatedProject.tasks || []
                        };

                        // 在數據更新後，確保 DOM 更新完成再初始化事件
                        this.$nextTick(() => {
                            this.initializeAllEventListeners();
                        });

                        this.error = null;
                    } catch (error) {
                        console.error('Error loading project:', error);
                        this.error = `Failed to load project: ${error.response?.data || error.message}`;
                    } finally {
                        this.loading = false;
                    }
                },

                showEditModal() {
                    if (this.editModal) {
                        this.project.startDate = this.formatDate(this.project.startDate);
                        this.project.endDate = this.project.endDate ? this.formatDate(this.project.endDate) : '';

                        console.log('Opening modal with project data:', {
                            ...this.project,
                            projectManagers: this.projectManagers
                        });

                        this.editModal.show();
                    }
                },

                handleSave() {
                    this.saveProject();
                },

                async saveProject() {
                    try {
                        if (!this.validateForm() || !this.validateDates()) {
                            return;
                        }

                        const projectData = {
                            projectId: this.project.projectId,
                            name: this.project.name,
                            description: this.project.description,
                            status: this.project.status,
                            ownerId: parseInt(this.project.ownerId, 10),
                            startDate: this.formatDate(this.project.startDate),
                            ...(this.project.endDate && this.project.endDate !== 'Not Set'
                                ? { endDate: this.formatDate(this.project.endDate) }
                                : {})
                        };

                        console.log('Saving project with data:', projectData);

                        const response = await axios.put(`/api/ProjectsApi/${this.project.projectId}`, projectData);

                        if (response.data) {
                            const updatedProject = response.data;
                            const currentTasks = this.project.tasks;

                            this.project = {
                                ...this.project,
                                ...updatedProject,
                                ownerId: updatedProject.ownerId.toString(),
                                startDate: this.formatDate(updatedProject.startDate),
                                endDate: updatedProject.endDate ? this.formatDate(updatedProject.endDate) : '',
                                tasks: currentTasks
                            };
                        } else {
                            await this.loadProject();
                        }

                        this.editModal.hide();
                        alert('Project updated successfully');
                    } catch (error) {
                        console.error('Error updating project:', error);
                        alert(`Failed to update project: ${error.response?.data || error.message}`);
                    }
                },

                validateForm() {
                    const form = document.getElementById('projectEditForm');
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        form.classList.add('was-validated');
                        return false;
                    }
                    return true;
                },

                validateDates() {
                    if (!this.project.endDate || this.project.endDate === 'Not Set') {
                        return true;
                    }

                    const startDate = new Date(this.project.startDate);
                    const endDate = new Date(this.project.endDate);

                    if (endDate < startDate) {
                        document.getElementById('endDate').setCustomValidity('End date must be after start date');
                        return false;
                    }

                    document.getElementById('endDate').setCustomValidity('');
                    return true;
                },

                resetFormValidation() {
                    const form = document.getElementById('projectEditForm');
                    form.classList.remove('was-validated');
                    const inputs = form.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => input.setCustomValidity(''));
                },

                //任務相關methods
                async showCreateTaskModal() {
                    if (!this.taskCreateModal) {      //初始化
                        this.taskCreateModal = new bootstrap.Modal(document.getElementById('taskCreateModal'));
                    }
                    //重置表單
                    this.taskForm = {
                        title: '',
                        description: '',
                        status: '未開始',  // 給預設值
                        priority: '',
                        dueDate: new Date().toISOString().split('T')[0],
                        assignedToId: null,
                        projectId: this.project.projectId
                    };
                    //清除之前的驗證
                    const form = document.getElementById('taskCreateForm');
                    if (form) {
                        form.classList.remove('was-validateed');
                        const inputs = form.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => input.setCustomValidity(''));
                    }
                    //打開 Modal
                    this.taskCreateModal.show();
                },

                handleSaveTask() {
                    if (this.isSubmitting) return;
                    this.createTask();
                },

                handleEditClick(taskId) {
                    const task = this.project.tasks.find(t => t.taskId === taskId);
                    if (task) {
                        // 重置表單驗證狀態
                        const form = document.getElementById('taskEditForm');
                        form.classList.remove('was-validated');
                        form.querySelectorAll('input, select, textarea').forEach(input => {
                            input.setCustomValidity('');
                        });
                        const dueDate = task.dueDate
                            ? new Date(task.dueDate).toISOString().split('T')[0]
                            : '';

                        // 設置表單數據
                        this.editTaskForm = {
                            taskId: task.taskId,
                            title: task.title,
                            description: task.description,
                            status: task.status,
                            priority: task.priority,
                            dueDate: dueDate,
                            assignedToId: task.assignedToId ? task.assignedToId.toString() : ''
                        };

                        console.log('Edit form data:', this.editTaskForm);  // 記錄表單資料
                        this.taskEditModal.show();
                    }
                },

                validateTaskForm(isEdit = false) {
                    const formId = isEdit ? 'taskEditForm' : 'taskCreateForm';
                    const form = document.getElementById(formId);
                    const formData = isEdit ? this.editTaskForm : this.taskForm;
                    const errors = {};

                    // 驗證標題
                    if (!formData.title?.trim()) {
                        errors.title = '標題不能為空';
                    }

                    // 驗證狀態
                    if (!formData.status) {
                        errors.status = '狀態不能為空';
                    } else if (!this.validationRules.statuses.includes(formData.status)) {
                        errors.status = '請選擇有效的狀態';
                    }

                    // 驗證優先級
                    if (!formData.priority) {
                        errors.priority = '優先級不能為空';
                    } else if (!this.validationRules.priorities.includes(formData.priority)) {
                        errors.priority = '請選擇有效的優先級';
                    }

                    // 驗證到期日 - 只檢查是否有值，不檢查日期範圍
                    if (!formData.dueDate) {
                        errors.dueDate = '到期日不能為空';
                    }

                    // 設置錯誤提示
                    Object.keys(errors).forEach(field => {
                        const prefix = isEdit ? 'editTask' : 'task';
                        const element = document.getElementById(`${prefix}${field.charAt(0).toUpperCase() + field.slice(1)}`);
                        if (element) {
                            element.setCustomValidity(errors[field]);
                        }
                    });

                    // 顯示驗證狀態
                    form.classList.add('was-validated');

                    // 添加輸入監聽（只添加一次）
                    if (!form.hasInputListeners) {
                        form.querySelectorAll('input, select, textarea').forEach(input => {
                            input.addEventListener('input', () => {
                                // 清除驗證訊息
                                input.setCustomValidity('');

                                // 特別處理標題輸入框
                                if (input.id === 'taskTitle' || input.id === 'editTaskTitle') {
                                    input.setCustomValidity('');
                                }
                            });
                        });
                        form.hasInputListeners = true;
                    }

                    return Object.keys(errors).length === 0;
                },

                async createTask() {
                    if (!this.validateTaskForm(false)) return;

                    try {
                        this.isSubmitting = true;
                        const saveBtn = document.getElementById('saveTaskBtn');
                        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>建立中...';
                        
                        // 確保日期格式正確
                        let formattedDate = this.taskForm.dueDate;
                        if (formattedDate) {
                            // 確保日期格式是 ISO 字串並且是此時區
                            const date = new Date(formattedDate);
                            if (!isNaN(date.getTime())) {
                                const localDate = new Date(Date.UTC(
                                    date.getFullYear(),
                                    date.getMonth(),
                                    date.getDate(),
                                    0, 0, 0
                                ));
                                formattedDate = localDate.toISOString();
                            }
                        }
                        const taskData = {
                            title: this.taskForm.title.trim(),
                            description: this.taskForm.description?.trim() || '',
                            status: this.taskForm.status,
                            priority: this.taskForm.priority,
                            dueDate: formattedDate,
                            assignedToId: this.taskForm.assignedToId ? parseInt(this.taskForm.assignedToId) : null
                        };

                        console.log('Sending task data:', taskData);

                        const response = await axios.post(
                            `/api/ProjectsApi/${this.project.projectId}/tasks`,
                            taskData
                        );

                        if (response.data) {
                            await this.loadProject();
                            this.taskCreateModal.hide();
                            alert('任務建立成功');
                        }
                    } catch (error) {
                        console.error('Error creating task:', error);
                        let errorMessage = '建立任務時發生錯誤';

                        if (error.response?.data) {
                            const errorResponse = error.response.data;
                            console.log('Error response:', errorResponse);

                            // 檢查 errorResponse 的類型和內容
                            if (typeof errorResponse === 'object') {
                                if (errorResponse.message) {
                                    // 使用 ErrorResponseDto 格式
                                    errorMessage = errorResponse.message;

                                    // 處理特定錯誤情況
                                    if (typeof errorMessage === 'string' && errorMessage.indexOf('標題已存在') !== -1) {
                                        // 標記標題欄位為無效
                                        const titleInput = document.getElementById('taskTitle');
                                        if (titleInput) {
                                            titleInput.setCustomValidity('此任務標題已存在');
                                            document.getElementById('taskCreateForm').classList.add('was-validated');
                                        }
                                    }
                                }

                                // 根據錯誤類型顯示適當訊息
                                if (errorResponse.error) {
                                    switch (errorResponse.error) {
                                        case 'ValidationError':
                                            // 使用已經設置的錯誤訊息
                                            break;
                                        case 'InvalidOperation':
                                            errorMessage = '無法在目前的專案狀態下建立任務';
                                            break;
                                        case 'NotFound':
                                            errorMessage = '找不到指定的專案';
                                            break;
                                        case 'InternalServerError':
                                            errorMessage = '服務器發生錯誤，請稍後再試';
                                            break;
                                    }
                                }
                            } else if (typeof errorResponse === 'string') {
                                errorMessage = errorResponse;
                            }
                        }

                        alert(errorMessage);

                        // 如果是標題重複的錯誤，保持表單開啟
                        if (typeof errorMessage === 'string' && errorMessage.indexOf('標題已存在') === -1) {
                            this.resetTaskForm();  // 其他錯誤則重置表單
                        }
                    } finally {
                        this.isSubmitting = false;
                        const saveBtn = document.getElementById('saveTaskBtn');
                        saveBtn.innerHTML = '建立任務';
                    }
                },

                async updateTask() {
                    if (this.isSubmitting) return;

                    if (!this.validateTaskForm(true)) {
                        return;
                    }

                    try {
                        this.isSubmitting = true;
                        const updateBtn = document.getElementById('updateTaskBtn');
                        updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>更新中...';

                        // 確保日期格式正確
                        let formattedDate = this.editTaskForm.dueDate;
                        if (formattedDate) {
                            // 確保日期格式是 ISO 字串並且是此時區
                            const date = new Date(formattedDate);
                            if (!isNaN(date.getTime())) {
                                const localDate = new Date(Date.UTC(
                                    date.getFullYear(),
                                    date.getMonth(),
                                    date.getDate(),
                                    0, 0, 0
                                ));
                                formattedDate = localDate.toISOString();
                            }
                        }

                        const taskData = {
                            taskId: this.editTaskForm.taskId,  // 加入 taskId
                            title: this.editTaskForm.title.trim(),
                            description: this.editTaskForm.description?.trim() || '',
                            status: this.editTaskForm.status,
                            priority: this.editTaskForm.priority,
                            dueDate: formattedDate,
                            assignedToId: this.editTaskForm.assignedToId ? parseInt(this.editTaskForm.assignedToId) : null
                        };

                        console.log('Sending update data:', taskData);

                        const response = await axios.put(
                            `/api/ProjectsApi/${this.project.projectId}/tasks/${this.editTaskForm.taskId}`,
                            taskData
                        );

                        if (response.data) {
                            await this.loadProject();
                            this.taskEditModal.hide();
                            alert('任務更新成功');
                        }
                    } catch (error) {
                        console.error('Error updating task:', error);
                        let errorMessage = '更新任務時發生錯誤';

                        if (error.response?.data) {
                            const errorResponse = error.response.data;
                            console.log('Error response:', errorResponse);

                            if (errorResponse.message) {
                                // 使用 ErrorResponseDto 的格式
                                errorMessage = `${errorResponse.message} (錯誤代碼: ${errorResponse.statusCode})`;

                                // 根據不同的錯誤類型顯示不同的訊息
                                switch (errorResponse.error) {
                                    case 'ValidationError':
                                        // 處理驗證錯誤
                                        break;
                                    case 'NotFound':
                                        errorMessage = '找不到要更新的任務';
                                        break;
                                    case 'InvalidOperation':
                                        errorMessage = '無法執行此操作';
                                        break;
                                    case 'InternalServerError':
                                        errorMessage = '服務器內部錯誤，請稍後再試';
                                        break;
                                }
                            } else if (typeof errorResponse === 'string') {
                                errorMessage = errorResponse;
                            }
                        }

                        alert(errorMessage);
                    } finally {
                        this.isSubmitting = false;
                        const updateBtn = document.getElementById('updateTaskBtn');
                        updateBtn.innerHTML = '更新任務';
                    }
                },

                resetTaskForm() {
                    this.taskForm = {
                        title: '',
                        description: '',
                        status: '',
                        priority: '',
                        dueDate: this.formatDate(new Date()),
                        assignedToId: '',
                        projectId: this.project.projectId
                    };

                    const form = document.getElementById('taskCreateForm');
                    if (form) {
                        form.classList.remove('was-validated');
                        const inputs = form.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => input.setCustomValidity(''));
                    }
                },

                resetEditTaskForm() {
                    this.editTaskForm = {
                        taskId: null,
                        title: '',
                        description: '',
                        status: '',
                        priority: '',
                        dueDate: '',
                        assignedToId: null
                    };

                    const form = document.getElementById('taskEditForm');
                    if (form) {
                        form.classList.remove('was-validated');
                        const inputs = form.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => input.setCustomValidity(''));
                    }
                },

                //處理刪除鈕點擊
                handleDeleteClick(btn) {
                    const taskId = btn.dataset.taskId;
                    if (taskId && confirm('確定要刪除此任務嗎？')) {
                        this.deleteTask(taskId);
                    }
                },

                async deleteTask(taskId) {
                    try 
                    {
                        this.isSubmitting = true;
                        const response = await axios.delete(
                            `/api/ProjectsApi/${this.project.projectId}/tasks/${taskId}`);
                        
                        if (response.data.success) {
                            await this.loadProject();
                            alert('任務刪除成功');
                        }
                    } 
                    catch (error) 
                    {
                        console.error('Error deleting task:', error);
                        const errorMessage = error.response?.data?.message || '刪除任務時發生錯誤';
                        alert(errorMessage);
                    } 
                    finally 
                    {
                        this.isSubmitting = false;
                    }
                },

                calculateDaysUntilDue(dueDate) {
                    const today = new Date();
                    const due = new Date(dueDate);
                    today.setHours(0, 0, 0, 0);
                    due.setHours(0, 0, 0, 0);
                    return Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                },

                getDaysRemaining(task) {
                    const days = this.calculateDaysUntilDue(task.dueDate);
                    return days < 0 ? `逾期 ${Math.abs(days)} 天` : `剩餘 ${days} 天`;
                },

                getTaskRowClass(task) {
                    if (task.status === '已完成') return '';
                    const days = this.calculateDaysUntilDue(task.dueDate);
                    return {
                        'table-danger': days < 0,
                        'table-warning': days >= 0 && days <= 3
                    };
                }

            },      

            mounted() {     
                this.loadProject();
            }
        }).mount('#app');
    </script>
}